name: Linux
on: [push, pull_request]
jobs:
  vanilla:
    strategy:
      matrix:
          version: ["8.0", "8.1", "8.2"]
          debug: ["enable", "disable"]
          asan: ["enable", "disable"]
    if: success() || failure()
    runs-on: ubuntu-latest
    name: Linux, PHP v${{matrix.version}}, ${{matrix.debug}}-debug, ${{matrix.asan}}-asan
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup PHP
        run: docker-compose build --build-arg PHP_SRC_DEBUG=${{matrix.debug}} --build-arg PHP_SRC_OPCACHE=disable --build-arg PHP_SRC_ASAN=${{matrix.asan}} php-${{matrix.version}}
      - name: Setup parallel
        run: docker-compose build parallel-${{matrix.version}}
      - name: Test parallel
        run: docker-compose run parallel-${{matrix.version}} docker/parallel.test
  opcache:
    strategy:
      matrix:
          version: ["8.0", "8.1", "8.2"]
          debug: ["enable", "disable"]
          asan: ["enable", "disable"]
    if: success() || failure()
    runs-on: ubuntu-latest
    name: Linux, PHP v${{matrix.version}}, ${{matrix.debug}}-debug, ${{matrix.asan}}-asan, opcache
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup PHP
        run: docker-compose build --build-arg PHP_SRC_DEBUG=${{matrix.debug}} --build-arg PHP_SRC_OPCACHE=enable --build-arg PHP_SRC_ASAN=${{matrix.asan}} php-${{matrix.version}}
      - name: Setup parallel
        run: docker-compose build parallel-${{matrix.version}}
      - name: Test parallel
        run: docker-compose run parallel-${{matrix.version}} docker/parallel.test -d opcache.enable_cli=1 -d opcache.jit=disable
  jit:
    strategy:
      matrix:
          version: ["8.0", "8.1", "8.2"]
          debug: ["enable", "disable"]
          asan: ["enable", "disable"]
    if: success() || failure()
    runs-on: ubuntu-latest
    name: Linux, PHP v${{matrix.version}}, ${{matrix.debug}}-debug, ${{matrix.asan}}-asan, JIT
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup PHP
        run: docker-compose build --build-arg PHP_SRC_DEBUG=${{matrix.debug}} --build-arg PHP_SRC_OPCACHE=enable --build-arg PHP_SRC_ASAN=${{matrix.asan}} php-${{matrix.version}}
      - name: Setup parallel
        run: docker-compose build parallel-${{matrix.version}}
      - name: Test parallel
        run: docker-compose run parallel-${{matrix.version}} docker/parallel.test -d opcache.enable_cli=1 -d opcache.jit=function -d opcache.jit_buffer_size=32M